from flask import Flask, render_template, request
from dotenv import load_dotenv

app = Flask(__name__)

import requests
import os
import json
from shapely.geometry import Point, Polygon

regions_geojson = [
    # Example for منطقه 1
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.51410377514691,
                35.78246072334677
                ],
                [
                51.534871326171526,
                35.804873247870944
                ],
                [
                51.533515674552746,
                35.82402212406184
                ],
                [
                51.42622666153767,
                35.82791383458587
                ],
                [
                51.38666875495937,
                35.81224077433572
                ],
                [
                51.39301927345198,
                35.805965685835744
                ],
                [
                51.397382899918426,
                35.79621691901083
                ],
                [
                51.39934664915501,
                35.792455864204115
                ],
                [
                51.41830351680116,
                35.7904335463527
                ],
                [
                51.42377365690746,
                35.78355001097617
                ],
                [
                51.4284940040435,
                35.77866918074798
                ],
                [
                51.43653466236563,
                35.78407866469131
                ],
                [
                51.4593343567783,
                35.79276512391945
                ],
                [
                51.48048924114195,
                35.78987282667546
                ],
                [
                51.51410377514691,
                35.78246072334677
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.38437641286609,
                35.80592420642658
                ],
                [
                51.35505109902144,
                35.80598626671835
                ],
                [
                51.33199348079734,
                35.788622389635236
                ],
                [
                51.335605015125736,
                35.779018864969785
                ],
                [
                51.33725127838579,
                35.766938246812416
                ],
                [
                51.331884642567076,
                35.750439234725064
                ],
                [
                51.33800954686026,
                35.69891148327288
                ],
                [
                51.34145339543966,
                35.69905294565774
                ],
                [
                51.37757487648739,
                35.700932547856794
                ],
                [
                51.378022090750335,
                35.7183121245144
                ],
                [
                51.3820945200203,
                35.725837412741924
                ],
                [
                51.38579573609297,
                35.7505282238355
                ],
                [
                51.389108416581735,
                35.7595631885722
                ],
                [
                51.3870165204313,
                35.769898314111245
                ],
                [
                51.39308127098394,
                35.78004944769572
                ],
                [
                51.39244919202275,
                35.78998357694989
                ],
                [
                51.38437641286609,
                35.80592420642658
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.38437641286609,
                35.80592420642658
                ],
                [
                51.35505109902144,
                35.80598626671835
                ],
                [
                51.33199348079734,
                35.788622389635236
                ],
                [
                51.335605015125736,
                35.779018864969785
                ],
                [
                51.33725127838579,
                35.766938246812416
                ],
                [
                51.331884642567076,
                35.750439234725064
                ],
                [
                51.33800954686026,
                35.69891148327288
                ],
                [
                51.34145339543966,
                35.69905294565774
                ],
                [
                51.37757487648739,
                35.700932547856794
                ],
                [
                51.378022090750335,
                35.7183121245144
                ],
                [
                51.3820945200203,
                35.725837412741924
                ],
                [
                51.38579573609297,
                35.7505282238355
                ],
                [
                51.389108416581735,
                35.7595631885722
                ],
                [
                51.3870165204313,
                35.769898314111245
                ],
                [
                51.39308127098394,
                35.78004944769572
                ],
                [
                51.39244919202275,
                35.78998357694989
                ],
                [
                51.38437641286609,
                35.80592420642658
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.447279795416506,
                35.74162671616368
                ],
                [
                51.462691709464025,
                35.740722819704374
                ],
                [
                51.47288818828952,
                35.73923860207239
                ],
                [
                51.490381739707345,
                35.7363039932539
                ],
                [
                51.52673199660265,
                35.73149130090516
                ],
                [
                51.5331579507133,
                35.730727068161
                ],
                [
                51.53728740662535,
                35.72918358327756
                ],
                [
                51.53879702667828,
                35.72464154439348
                ],
                [
                51.52827902238511,
                35.72401321706559
                ],
                [
                51.55926007846932,
                35.72621336262222
                ],
                [
                51.58482796029239,
                35.72353416482672
                ],
                [
                51.58924803544505,
                35.727146069235005
                ],
                [
                51.60274788694025,
                35.73722900281588
                ],
                [
                51.60592160813735,
                35.74384631164058
                ],
                [
                51.59306490958957,
                35.74829019723866
                ],
                [
                51.58802723359244,
                35.74820940261726
                ],
                [
                51.57954548955797,
                35.75213356319679
                ],
                [
                51.56997157557305,
                35.761918457421686
                ],
                [
                51.55183749759874,
                35.771987859207
                ],
                [
                51.52165118386091,
                35.77766291869
                ],
                [
                51.51356689453593,
                35.78205101933277
                ],
                [
                51.49919257994094,
                35.78624457442507
                ],
                [
                51.49209864591106,
                35.785437949784225
                ],
                [
                51.485731503760206,
                35.7881816534734
                ],
                [
                51.47690332174781,
                35.79014724095339
                ],
                [
                51.470162192290616,
                35.78568695501916
                ],
                [
                51.455449352540654,
                35.76496491549341
                ],
                [
                51.45195791362215,
                35.75368770635541
                ],
                [
                51.44854941742318,
                35.75195115779296
                ],
                [
                51.447279795416506,
                35.74162671616368
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.337893995968216,
                35.69926436330874
                ],
                [
                51.332155495325964,
                35.75103558954898
                ],
                [
                51.33774295148143,
                35.766797333537355
                ],
                [
                51.33206641203387,
                35.78816345066312
                ],
                [
                51.260869665344615,
                35.78205893268347
                ],
                [
                51.264769778829105,
                35.7655851149065
                ],
                [
                51.265848069743186,
                35.7568718973788
                ],
                [
                51.268214363663446,
                35.75601356457304
                ],
                [
                51.26907123048622,
                35.75209417597175
                ],
                [
                51.26715212303549,
                35.746737696388436
                ],
                [
                51.269917465964994,
                35.73848682957592
                ],
                [
                51.27656897554559,
                35.73250081525087
                ],
                [
                51.28116886906798,
                35.73045098289484
                ],
                [
                51.29085301619037,
                35.716569006543
                ],
                [
                51.28978782189475,
                35.70084869495007
                ],
                [
                51.337893995968216,
                35.69926436330874
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.37801423313829,
                35.70073010745469
                ],
                [
                51.42603297686162,
                35.701632034204934
                ],
                [
                51.425720123668555,
                35.71257068713197
                ],
                [
                51.42724697138169,
                35.71907958537159
                ],
                [
                51.42402827794689,
                35.72634848420762
                ],
                [
                51.420116344552355,
                35.73172555817838
                ],
                [
                51.42195323348568,
                35.7349588851427
                ],
                [
                51.4224823248459,
                35.747131019653054
                ],
                [
                51.417625979334645,
                35.75165295513712
                ],
                [
                51.38615395052983,
                35.75037011206079
                ],
                [
                51.38369823083161,
                35.74225946540132
                ],
                [
                51.38335264847504,
                35.72888767301808
                ],
                [
                51.377884535383345,
                35.718478271435714
                ],
                [
                51.37801423313829,
                35.70073010745469
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.42591515023304,
                35.7018080232247
                ],
                [
                51.443141172105555,
                35.70166850861993
                ],
                [
                51.454952228261305,
                35.70343171725081
                ],
                [
                51.472750645532045,
                35.709286836612236
                ],
                [
                51.45941563017439,
                35.72601040572093
                ],
                [
                51.45840848901216,
                35.73011178680203
                ],
                [
                51.46143136310462,
                35.73349891681046
                ],
                [
                51.46689840457137,
                35.740320090028376
                ],
                [
                51.46058647556799,
                35.74086133675955
                ],
                [
                51.43611568354379,
                35.742175799911834
                ],
                [
                51.42324604176227,
                35.7400101186678
                ],
                [
                51.42013085649353,
                35.73112307025683
                ],
                [
                51.427030494423775,
                35.71882971942841
                ],
                [
                51.42572901986975,
                35.71279115325132
                ],
                [
                51.42591515023304,
                35.7018080232247
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.47281957678615,
                35.70927500062369
                ],
                [
                51.47495417262667,
                35.70966144421327
                ],
                [
                51.47388625951825,
                35.70927525235447
                ],
                [
                51.5380051221598,
                35.72464697869631
                ],
                [
                51.5383463906536,
                35.72359561453342
                ],
                [
                51.53669543234136,
                35.730280755799086
                ],
                [
                51.51711398878493,
                35.732693374362796
                ],
                [
                51.466782251859996,
                35.740431210195425
                ],
                [
                51.45846712135125,
                35.72973776483994
                ],
                [
                51.459860742236316,
                35.72513918926164
                ],
                [
                51.47281957678615,
                35.70927500062369
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.355148968903706,
                35.700229853603915
                ],
                [
                51.33740918758588,
                35.69994669424278
                ],
                [
                51.30158372483709,
                35.69878362578697
                ],
                [
                51.28999755926682,
                35.70089892894197
                ],
                [
                51.28930039038855,
                35.6944243033748
                ],
                [
                51.28455005941538,
                35.6851402444087
                ],
                [
                51.278796248688735,
                35.67656447057146
                ],
                [
                51.28394299921328,
                35.676508292548945
                ],
                [
                51.30939525910068,
                35.67567050643743
                ],
                [
                51.30987737714875,
                35.67181287019086
                ],
                [
                51.32671916778796,
                35.66855622697096
                ],
                [
                51.343513448024964,
                35.66631853414084
                ],
                [
                51.35246126776883,
                35.67056869004358
                ],
                [
                51.35464192640458,
                35.67848959707375
                ],
                [
                51.35505623869824,
                35.68701282644486
                ],
                [
                51.35644719178708,
                35.69379106270489
                ],
                [
                51.355473524624216,
                35.69620096345014
                ],
                [
                51.355148968903706,
                35.700229853603915
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.35509502619661,
                35.70014933329533
                ],
                [
                51.35647166891479,
                35.69417749005083
                ],
                [
                51.352462835210076,
                35.670723548455356
                ],
                [
                51.36875939543276,
                35.66697248438706
                ],
                [
                51.38152288815334,
                35.67109444539459
                ],
                [
                51.37815931220672,
                35.700753579850016
                ],
                [
                51.35509502619661,
                35.70014933329533
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.38214582010352,
                35.65960136380471
                ],
                [
                51.3923047977585,
                35.657962788754716
                ],
                [
                51.39377239198464,
                35.659784546886414
                ],
                [
                51.40486088169101,
                35.658592128080585
                ],
                [
                51.40549554378336,
                35.66272963939019
                ],
                [
                51.4128555186536,
                35.70150962367924
                ],
                [
                51.408494356060714,
                35.70137674785205
                ],
                [
                51.378072249926845,
                35.70053698931433
                ],
                [
                51.379457141117115,
                35.68741165045667
                ],
                [
                51.38131246322985,
                35.67084040127682
                ],
                [
                51.38214582010352,
                35.65960136380471
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.40479155115901,
                35.658673861472025
                ],
                [
                51.41049892721341,
                35.65839610662884
                ],
                [
                51.41654397293138,
                35.65881944713503
                ],
                [
                51.445094380561585,
                35.66069673220389
                ],
                [
                51.44814288683057,
                35.70199782247917
                ],
                [
                51.44701929478677,
                35.70190987149985
                ],
                [
                51.412740909836884,
                35.70148085208902
                ],
                [
                51.40479155115901,
                35.658673861472025
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.44817198048881,
                35.70195998514494
                ],
                [
                51.44732529009991,
                35.68963572708465
                ],
                [
                51.45996051589344,
                35.6904820889699
                ],
                [
                51.49230132282554,
                35.69288136266864
                ],
                [
                51.494125631376306,
                35.692695194461876
                ],
                [
                51.50116141503153,
                35.70168093407753
                ],
                [
                51.51271549873556,
                35.706521174328444
                ],
                [
                51.51223023992361,
                35.71747692102127
                ],
                [
                51.54452223092238,
                35.716743524455666
                ],
                [
                51.571180167865265,
                35.71645065688848
                ],
                [
                51.58188994671116,
                35.720074187169644
                ],
                [
                51.59125038910997,
                35.720795708169845
                ],
                [
                51.59587778035649,
                35.721797330162545
                ],
                [
                51.59614569386406,
                35.7238480996385
                ],
                [
                51.59614569386406,
                35.7242209611443
                ],
                [
                51.5894095828404,
                35.72341309234211
                ],
                [
                51.58611807404492,
                35.72434524792449
                ],
                [
                51.57547808049702,
                35.7238170277668
                ],
                [
                51.5608071054518,
                35.72618461317079
                ],
                [
                51.53505238823075,
                35.72460396465124
                ],
                [
                51.51897609447525,
                35.7233275878628
                ],
                [
                51.47760715659339,
                35.71045793197837
                ],
                [
                51.44883774470995,
                35.70223139830489
                ],
                [
                51.44817198048881,
                35.70195998514494
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.44730104178518,
                35.68962189425511
                ],
                [
                51.44707224392562,
                35.68547641158537
                ],
                [
                51.446720748307655,
                35.68069867298074
                ],
                [
                51.44609037538268,
                35.67345403913343
                ],
                [
                51.44562260899403,
                35.66534414948205
                ],
                [
                51.44914139732953,
                35.66504322349299
                ],
                [
                51.45271309977514,
                35.663173157991864
                ],
                [
                51.45980879987442,
                35.659280068399525
                ],
                [
                51.46229576305774,
                35.6587426589531
                ],
                [
                51.465655809063094,
                35.659774481896264
                ],
                [
                51.471979045243785,
                35.658699666040704
                ],
                [
                51.48838295862339,
                35.65626570060333
                ],
                [
                51.49082768986517,
                35.66270931465937
                ],
                [
                51.50173422099414,
                35.66028220647232
                ],
                [
                51.49708498100088,
                35.64654512733996
                ],
                [
                51.49901634602551,
                35.64482513017556
                ],
                [
                51.50677738844951,
                35.64433063152411
                ],
                [
                51.5130212534651,
                35.64839409037923
                ],
                [
                51.51673420440383,
                35.65547027409153
                ],
                [
                51.52342766479637,
                35.66893956455148
                ],
                [
                51.51366941898522,
                35.67359165053391
                ],
                [
                51.5189079159052,
                35.67722379232259
                ],
                [
                51.50857129412623,
                35.68746365935955
                ],
                [
                51.49481551595639,
                35.69286047300835
                ],
                [
                51.44730104178518,
                35.68962189425511
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.43050006305867,
                35.659757834579224
                ],
                [
                51.43183579889299,
                35.65622266895221
                ],
                [
                51.43433084211412,
                35.643312372192014
                ],
                [
                51.436709317703816,
                35.624697810027726
                ],
                [
                51.45105626936905,
                35.624865060050325
                ],
                [
                51.4590140370195,
                35.62459270354596
                ],
                [
                51.46376107175348,
                35.62231730472648
                ],
                [
                51.47172047200715,
                35.618769434211245
                ],
                [
                51.471720471874704,
                35.616734310277934
                ],
                [
                51.477495259269034,
                35.612664104643116
                ],
                [
                51.480318201545,
                35.61370737477496
                ],
                [
                51.49392025101315,
                35.60745124903836
                ],
                [
                51.50012426534215,
                35.602616882161044
                ],
                [
                51.504099727310575,
                35.60438053463322
                ],
                [
                51.49731572356089,
                35.609635963315384
                ],
                [
                51.51160796396218,
                35.616169229207784
                ],
                [
                51.50536704347877,
                35.63105483781386
                ],
                [
                51.50490472349907,
                35.63630056810548
                ],
                [
                51.501550612741795,
                35.63727302404607
                ],
                [
                51.501758297365996,
                35.644457459253886
                ],
                [
                51.498916018403605,
                35.644764130244965
                ],
                [
                51.49733505926869,
                35.64666569609291
                ],
                [
                51.501750395180494,
                35.66017551023198
                ],
                [
                51.490883201303376,
                35.662646888621865
                ],
                [
                51.488417807693736,
                35.65627706691626
                ],
                [
                51.466058247665416,
                35.6595502574977
                ],
                [
                51.46049294149745,
                35.65919105347889
                ],
                [
                51.44568943682333,
                35.665203627554874
                ],
                [
                51.44518268319811,
                35.66078463586241
                ],
                [
                51.43050006305867,
                35.659757834579224
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },


    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.43063400431353,
                35.65962473564814
                ],
                [
                51.40990625905491,
                35.658005328884485
                ],
                [
                51.39377986937191,
                35.65969600264687
                ],
                [
                51.39303642310904,
                35.65824690840884
                ],
                [
                51.38233504007573,
                35.65951490364458
                ],
                [
                51.38219130791822,
                35.66410186592283
                ],
                [
                51.382258688683635,
                35.65401966458849
                ],
                [
                51.388944753930815,
                35.65003182766253
                ],
                [
                51.39344629356174,
                35.64507360978973
                ],
                [
                51.39091551656179,
                35.63933577040277
                ],
                [
                51.393126626487685,
                35.631702980318636
                ],
                [
                51.393853935936704,
                35.62919058942785
                ],
                [
                51.39530855483321,
                35.628858061187145
                ],
                [
                51.40303621772304,
                35.61936194888716
                ],
                [
                51.40020451794007,
                35.614592315943156
                ],
                [
                51.40232550843774,
                35.61415612984685
                ],
                [
                51.41584162237166,
                35.61572294600144
                ],
                [
                51.4213681227954,
                35.61887112774322
                ],
                [
                51.43640474124683,
                35.6273986524447
                ],
                [
                51.43063400431353,
                35.65962473564814
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.34461737001175,
                35.66719699376594
                ],
                [
                51.34404289178883,
                35.663735179346375
                ],
                [
                51.355400044766014,
                35.637258852616256
                ],
                [
                51.369629093484036,
                35.644310261457235
                ],
                [
                51.37474732717513,
                35.653217698305866
                ],
                [
                51.38214302980933,
                35.6548363655389
                ],
                [
                51.38155928950084,
                35.67093885018973
                ],
                [
                51.375127671225385,
                35.668412858320565
                ],
                [
                51.367929369975286,
                35.66695951170668
                ],
                [
                51.36098662971756,
                35.668205238995554
                ],
                [
                51.3522183996927,
                35.6706000217268
                ],
                [
                51.34461737001175,
                35.66719699376594
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.355310944198465,
                35.63705695699133
                ],
                [
                51.343840552823934,
                35.666474521463584
                ],
                [
                51.30933901459548,
                35.67202195051688
                ],
                [
                51.30983277469892,
                35.675754796499206
                ],
                [
                51.295540597907404,
                35.67574544164988
                ],
                [
                51.247263043961624,
                35.68017032325497
                ],
                [
                51.23311236707394,
                35.683598666964045
                ],
                [
                51.23226959139038,
                35.67131419316573
                ],
                [
                51.23745150142378,
                35.66404500308947
                ],
                [
                51.28550802752102,
                35.645054122339815
                ],
                [
                51.31633464064669,
                35.63017362288038
                ],
                [
                51.325542923864134,
                35.620742443414926
                ],
                [
                51.355310944198465,
                35.63705695699133
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.32560516045018,
                35.62119199677436
                ],
                [
                51.32993766595001,
                35.61455648844951
                ],
                [
                51.33711165950652,
                35.60993610144773
                ],
                [
                51.348793835991216,
                35.60766653664648
                ],
                [
                51.36026703546335,
                35.610632211300185
                ],
                [
                51.37667173836712,
                35.61416882430119
                ],
                [
                51.40090704585617,
                35.614448967778344
                ],
                [
                51.403369940222404,
                35.6192143047067
                ],
                [
                51.404749136567716,
                35.6205757660606
                ],
                [
                51.393326711435975,
                35.63763305044978
                ],
                [
                51.39165705541251,
                35.63710394995468
                ],
                [
                51.39153937575395,
                35.63973454854268
                ],
                [
                51.393602346634765,
                35.645350157020204
                ],
                [
                51.38113511785565,
                35.65488684040565
                ],
                [
                51.373128229476265,
                35.65241899281456
                ],
                [
                51.36844414345086,
                35.6437772831605
                ],
                [
                51.353797146694916,
                35.63647815790358
                ],
                [
                51.339705961290264,
                35.629848441597474
                ],
                [
                51.32560516045018,
                35.62119199677436
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },
    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.40103568774336,
                35.61453940137555
                ],
                [
                51.40771377298856,
                35.610747650687415
                ],
                [
                51.406812683943656,
                35.60682631111699
                ],
                [
                51.40638862595753,
                35.60471471545182
                ],
                [
                51.40617009422914,
                35.60347922080359
                ],
                [
                51.4117109184717,
                35.602653810612935
                ],
                [
                51.416524796525096,
                35.58850252825559
                ],
                [
                51.416956903289275,
                35.57811291339094
                ],
                [
                51.41699046239796,
                35.57397222575881
                ],
                [
                51.419492743340726,
                35.57270868735661
                ],
                [
                51.42052878420756,
                35.56919698380631
                ],
                [
                51.42665606626596,
                35.56961825104939
                ],
                [
                51.42812329398848,
                35.569547894077274
                ],
                [
                51.427949838341675,
                35.57558532344551
                ],
                [
                51.42777703830188,
                35.57677863201452
                ],
                [
                51.42975907155895,
                35.579306142045894
                ],
                [
                51.42706266101405,
                35.581760978514
                ],
                [
                51.42730045108962,
                35.582728348017795
                ],
                [
                51.43199873594622,
                35.58238977763061
                ],
                [
                51.437352405365544,
                35.58021299742363
                ],
                [
                51.43860027828029,
                35.582244667950704
                ],
                [
                51.44692741371486,
                35.58103538407016
                ],
                [
                51.45246926284912,
                35.58308972285154
                ],
                [
                51.45199338618312,
                35.57922072350797
                ],
                [
                51.45163633784699,
                35.57791487049806
                ],
                [
                51.45627496306625,
                35.57936584868072
                ],
                [
                51.457880601146854,
                35.57965603153038
                ],
                [
                51.46067575240298,
                35.5757865231201
                ],
                [
                51.464720255944144,
                35.57249685651365
                ],
                [
                51.470250575898405,
                35.55835875649623
                ],
                [
                51.478221152319605,
                35.56010084919552
                ],
                [
                51.471497611186095,
                35.570600505442684
                ],
                [
                51.464122677519896,
                35.58215876944921
                ],
                [
                51.45883505865544,
                35.591428948926406
                ],
                [
                51.45463602602453,
                35.59777131329574
                ],
                [
                51.454160255012255,
                35.59839993021917
                ],
                [
                51.4555880418483,
                35.60613340354219
                ],
                [
                51.45599738884806,
                35.61030882926363
                ],
                [
                51.46790340715165,
                35.61476122834095
                ],
                [
                51.47159349551228,
                35.61872891967022
                ],
                [
                51.460879103406654,
                35.62419522991547
                ],
                [
                51.43719901224037,
                35.6248125437334
                ],
                [
                51.43595020102961,
                35.62776144929083
                ],
                [
                51.425181499781246,
                35.621723599569236
                ],
                [
                51.41709130941118,
                35.616067056028825
                ],
                [
                51.41054840242401,
                35.614616413203876
                ],
                [
                51.40103568774336,
                35.61453940137555
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.29053468687749,
                35.71688263057891
                ],
                [
                51.28321467390518,
                35.716119273814584
                ],
                [
                51.250861143318474,
                35.71456418989682
                ],
                [
                51.20224356208632,
                35.72224512258083
                ],
                [
                51.157957942970626,
                35.7401496101906
                ],
                [
                51.13884051845588,
                35.74517176120577
                ],
                [
                51.121471003230795,
                35.742065283616256
                ],
                [
                51.091116278886005,
                35.745170596503954
                ],
                [
                51.093206429581585,
                35.748965489200955
                ],
                [
                51.089187841491764,
                35.7429034958877
                ],
                [
                51.12332853522372,
                35.73340906243692
                ],
                [
                51.13742224885874,
                35.71865917986119
                ],
                [
                51.15120273514984,
                35.71283956804838
                ],
                [
                51.14953445935146,
                35.709705089572026
                ],
                [
                51.2316259016215,
                35.681778635274455
                ],
                [
                51.2331597828333,
                35.68344357535638
                ],
                [
                51.27918170341664,
                35.6774621126263
                ],
                [
                51.290145117280304,
                35.69465642928179
                ],
                [
                51.29053468687749,
                35.71688263057891
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    },

    {
    "type": "FeatureCollection",
    "features": [
        {
        "type": "Feature",
        "properties": {},
        "geometry": {
            "coordinates": [
            [
                [
                51.29080613874015,
                35.717085214092265
                ],
                [
                51.27739111589139,
                35.73284413463085
                ],
                [
                51.266569437531984,
                35.745729552811284
                ],
                [
                51.26722184865986,
                35.76060483831593
                ],
                [
                51.26226334505051,
                35.77113160406151
                ],
                [
                51.26076377582376,
                35.77398830822655
                ],
                [
                51.21737398769005,
                35.76893659688463
                ],
                [
                51.21299733211734,
                35.76382653574419
                ],
                [
                51.19002956060399,
                35.76223598774952
                ],
                [
                51.186918397162515,
                35.76356264935586
                ],
                [
                51.18397705589834,
                35.7653273473443
                ],
                [
                51.15198846575149,
                35.76104029969716
                ],
                [
                51.133596371639015,
                35.7551447318766
                ],
                [
                51.11740345097809,
                35.75322567213402
                ],
                [
                51.10798166038086,
                35.74757814826194
                ],
                [
                51.092970263141495,
                35.7490542758723
                ],
                [
                51.09158965489317,
                35.74621626624605
                ],
                [
                51.12047607247226,
                35.742039747012214
                ],
                [
                51.139168773528496,
                35.74516668885161
                ],
                [
                51.20935388575717,
                35.72075929086901
                ],
                [
                51.252297633960865,
                35.71469084220885
                ],
                [
                51.29080613874015,
                35.717085214092265
                ]
            ]
            ],
            "type": "Polygon"
        }
        }
    ]
    }
    
]

load_dotenv()

neshan_api_key = os.getenv("NESHAN_API_KEY")

API_KEY = os.getenv("NESHAN_API_KEY", neshan_api_key)

def get_geocoding(address, api_key):
    """Convert address to latitude and longitude using Neshan API."""
    url = "https://api.neshan.org/v4/geocoding"
    headers = {"Api-Key": api_key}
    params = {"address": address}

    response = requests.get(url, headers=headers, params=params)

    if response.status_code == 200:
        data = response.json()
        if data.get("status") == "OK":
            location = data.get("location", {})
            return location.get("x"), location.get("y")
        else:
            print("Error in response status:", data.get("status"))
    else:
        print("HTTP Error:", response.status_code)

    return None, None

def is_point_in_region(geo_json_data, longitude, latitude):
    """Check if a point lies within a polygon defined by GeoJSON data."""
    coordinates = geo_json_data['features'][0]['geometry']['coordinates'][0]
    region_polygon = Polygon([(lon, lat) for lon, lat in coordinates])
    point = Point(longitude, latitude)
    return region_polygon.contains(point)

@app.route("/", methods=["GET", "POST"])
def index():
    region = None
    error = None

    if request.method == "POST":
        address = request.form["address"]
        longitude, latitude = get_geocoding(address, API_KEY)

        if longitude and latitude:
            for index, region_geojson in enumerate(regions_geojson):
                if is_point_in_region(region_geojson, longitude, latitude):
                    region = f"منطقه {index + 1}"
                    break
            else:
                error = "متاسفانه این آدرس در منطقه‌های تهران شناسایی نشده است."
        else:
            error = "خطا در دریافت مختصات آدرس. لطفاً آدرس را بررسی کنید."

    return render_template("index.html", region=region, error=error)

if __name__ == "__main__":
    app.run(debug=True)
